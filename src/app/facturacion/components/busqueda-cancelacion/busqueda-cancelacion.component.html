<div class="container">

  <div class="row mt-3 mx-2">
    <div class="col-4">
      <label for="concepto">Proyecto:</label>
      <div class="">
        <p-dropdown class="w-full" styleClass="w-full"
          [options]="filtroProyectos" (onChange)="onChangeCombo($event, 1)" 
          [disabled]="isDisableProyecto" placeholder="Selecciona un proyecto" 
          optionLabel="name" [showClear]="true" #dropDownProyecto></p-dropdown>
      </div>
    </div>
    <div class="col-4">
      <label for="descripcion">Empresa:</label>
      <div class="">
        <p-dropdown class="w-full" styleClass="w-full"
          [options]="filtroEmpresas" (onChange)="onChangeCombo($event, 2)" 
          [disabled]="isDisableEmpresa" placeholder="Selecciona una empresa" 
          optionLabel="name" [showClear]="true" #dropDownEmpresa></p-dropdown>
      </div>

    </div>
    <div class="col-4">
      <label for="email">Cliente:</label>
      <div class="">
        <p-dropdown class="w-full" styleClass="w-full"
          [options]="filtroClientes" (onChange)="onChangeCombo($event, 3)"
          [disabled]="isDisableCliente" placeholder="Selecciona un cliente" 
          optionLabel="name" [showClear]="true" #dropDownCliente></p-dropdown>
      </div>
    </div>
  </div>
  
  <div class="row mt-2 mx-2">
    <div class="col-4">
      <label for="email">Fecha Inicio:</label>
        <div class="">
        <p-calendar [showIcon]="true" styleClass="w-full"
        dateFormat="dd/mm/yy" [maxDate]="maxDate" [(ngModel)]="fechaInicio"></p-calendar>
        <!-- [disabled]="isConsulta" -->
        </div>
    </div>
    <div class="col-4">
      <label for="email">Fecha Fin:</label>
        <div class="">
        <p-calendar [showIcon]="true" styleClass="w-full"
        dateFormat="dd/mm/yy" [maxDate]="maxDate" [(ngModel)]="fechaFin" ></p-calendar>
        <!-- [disabled]="isConsulta" -->
        </div>
    </div>
    <div class="col-4"></div>
  </div>

  <div class="row border-top border-bottom">
    <div class="col-12 text-center">
        <p-button *ngIf="isClear" label="Limpiar filtros" styleClass="p-button-raised p-button-text p-button-secondary me-2" (click)="clearFiltros()"></p-button>
        <p-button label="Buscar" styleClass="p-button-raised p-button-text p-button-secondary" (click)="busqueda()"></p-button>
    </div>
  </div>

  <div *ngIf="listBusquedaUnique && listBusquedaUnique.length > 0" class="mt-3">

    <div class="row">
      <div class="col-12">
        <button type="button" (click)="exportJsonToExcel()" pButton pRipple icon="pi pi-file-excel" class="p-button-success"  pTooltip="Exportar Excel" tooltipPosition="bottom"></button>
      </div>
    </div>

    <div class="">
     
        
        <p-table [value]="listBusquedaUnique" styleClass="p-datatable-striped" [scrollable]="true" scrollHeight="700px">
          <ng-template pTemplate="header">
            <tr>
              <th *ngFor="let val of getHeadersTabla()">{{val}}</th>

            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-bus>
            <tr>
              <td>
                {{bus.uuid}}
              </td>
              <td>{{bus.numProyecto}}</td>
              <td>{{bus.idTipoFactura}}</td>
              <td>{{bus.idMoneda}}</td>
              <td>{{bus.importe}}</td>
              <td>{{bus.iva}}</td>
              <td>{{bus.ivaRet}}</td>
              <td>{{bus.total}}</td>
              <td>{{bus.concepto}}</td>
              <td>{{bus.mes}}</td>
              <td>{{bus.anio}}</td>
              <td>{{bus.fechaEmision}}</td>
              <td>{{bus.fechaPago}}</td>
              <td>{{bus.fechaCancelacion}}</td>
              <td>{{bus.noFactura}}</td>
              <td>{{bus.tipoCambio}}</td>
              <td>{{bus.motivoCancelacion}}</td>
             <!--  <td>{{bus.nC_UuidNotaCredito}}</td>
              <td>{{bus.nC_IdMoneda}}</td>
              <td>{{bus.nC_IdTipoRelacion}}</td>
              <td>{{bus.nC_NotaCredito}}</td>
              <td>{{bus.nC_Importe}}</td>
              <td>{{bus.nC_Iva}}</td>
              <td>{{bus.nC_Total}}</td>
              <td>{{bus.nC_Concepto}}</td>
              <td>{{bus.nC_Mes}}</td>
              <td>{{bus.nC_Anio}}</td>
              <td>{{bus.nC_TipoCambio}}</td>
              <td>{{bus.nC_FechaNotaCredito}}</td>
              <td>{{bus.c_UuidCobranza}}</td>
              <td>{{bus.c_IdMonedaP}}</td>
              <td>{{bus.c_ImportePagado}}</td>
              <td>{{bus.c_ImpSaldoAnt}}</td>
              <td>{{bus.c_ImporteSaldoInsoluto}}</td>
              <td>{{bus.c_IvaP}}</td>
              <td>{{bus.c_TipoCambioP}}</td>
              <td>{{bus.c_FechaPago}}</td> -->
              <td *ngIf="bus.fechaCancelacion == null || bus.fechaCancelacion == '' ">

                  <i class="pi pi-trash c-del"  title="Cancelar factura"
                  tooltipPosition="left" (click)="showModalDialog(bus.id)"></i>
                </td>
                <td>
                  <i class="pi pi-eye"  title="Ver notas de crédito"
                  tooltipPosition="left" (click)="show(true, bus.uuid)"></i>
                  </td>
                  <td>
                    <i class="pi pi-eye"  title="Ver pago"
                    tooltipPosition="left" (click)="show(false, bus.uuid)"></i>
                    </td>
            </tr>
          </ng-template>
        </p-table>


    </div>
  </div>
</div>

<p-confirmDialog [style]="{width: '30vw'}" [baseZIndex]="10000"></p-confirmDialog>
<p-toast></p-toast>


<p-dialog header="Cancelación" [(visible)]="displayModal" [modal]="true" [style]="{width: '50vw'}" [baseZIndex]="10000"
    [draggable]="false" [resizable]="false">
    <div class="row d-flex justify-content-center">
      <label for="">
        <strong style="color: red;">* Debe ingresar una descripción</strong>
       </label>
    </div>
    <div  class="row d-flex justify-content-center">
        <textarea placeholder="Ingrese al menos {{count_carapteres}} caracteres" [rows]="3" [cols]="80" pInputTextarea  [(ngModel)]="motivoCancelacion"></textarea>
    </div>
        <ng-template pTemplate="footer">
            <p-button icon="pi pi-check" (click)="changeCancelar()" label="Aceptar" class="p-button-text" [disabled]="motivoCancelacion.length < count_carapteres"></p-button>
            <p-button icon="pi pi-times" (click)="displayModal=false" label="Cancelar"></p-button>
        </ng-template>
</p-dialog>

<p-dialog [header]="headerModalCancelacion"
    [(visible)]="isCancelacionVisible" [modal]="true"
    [draggable]="true" [resizable]="true"
    [style]="{width: '75vw'}"
    [baseZIndex]="10000">
    <p>
      <p-table [value]="listBusquedaModal" [tableStyle]="{'min-width': '50rem'}">
        <ng-template pTemplate="header" ngIf="isTypeHeader">
          <tr>
            <th *ngFor="let val of getHeadersModal()">{{val}}</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-bus>
          <ng-container *ngIf="isTypeHeader">
            <tr *ngIf="bus.nC_Anio != '0'">
            <td>{{bus.nC_UuidNotaCredito}}</td>
            <td>{{bus.nC_IdMoneda}}</td>
            <td>{{bus.nC_IdTipoRelacion}}</td>
            <td>{{bus.nC_NotaCredito}}</td>
            <td>{{bus.nC_Importe}}</td>
            <td>{{bus.nC_Iva}}</td>
            <td>{{bus.nC_Total}}</td>
            <td>{{bus.nC_Concepto}}</td>
            <td>{{bus.nC_Mes}}</td>
            <td>{{bus.nC_Anio}}</td>
            <td>{{bus.nC_TipoCambio}}</td>
            <td>{{bus.nC_FechaNotaCredito}}</td>
            </tr>
          </ng-container>

          <ng-container *ngIf="!isTypeHeader">
            <tr>
              <td>{{bus.c_UuidCobranza}}</td>
              <td>{{bus.c_IdMonedaP}}</td>
              <td>{{bus.c_ImportePagado}}</td>
              <td>{{bus.c_ImpSaldoAnt}}</td>
              <td>{{bus.c_ImporteSaldoInsoluto}}</td>
              <td>{{bus.c_IvaP}}</td>
              <td>{{bus.c_TipoCambioP}}</td>
              <td>{{bus.c_FechaPago}}</td>
            </tr>
          </ng-container>

        </ng-template>
    </p-table>
    </p>
</p-dialog>
